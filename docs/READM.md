## MR麻雀アプリケーション プロジェクトドキュメント (v1.1 MVP版)

### バージョン: 1.1
### 変更日: 2025/09/29

---

## 第1部 要件定義書

### 1.1. プロジェクト概要
本プロジェクトは、**アカウント登録不要**で、友人とすぐに3人打ち麻雀を楽しめる手軽なMRアプリケーションを開発することを目的とします。ユーザーはアプリ起動後すぐにルームIDを発行し、それを共有するだけで対局を開始できます。

* **ターゲットユーザー**:
    * 友人や家族と、**事前の準備なく**すぐにMR麻雀をプレイしたいユーザー。
* **提供価値**:
    * アカウント作成の手間をなくし、「集まってすぐ遊ぶ」体験をデジタルで実現する**手軽さと即時性**。
    * MR空間とハンドトラッキングによる、直感的で没入感のある対局体験。

### 1.2. 機能要件
本アプリが提供する機能を、MVP（Minimum Viable Product）として以下に絞り込みます。

| ID | 機能分類 | 機能名 | 概要 | 優先度 |
| :--- | :--- | :--- | :--- | :--- |
| FR-01 | ロビー | **ルーム作成とID発行** | サーバー側で一意のルームIDを発行し、ホストプレイヤーに表示する。 | **高** |
| FR-02 | | **IDによるルーム参加** | 共有されたルームIDを入力して、指定の対局に参加できる。 | **高** |
| FR-03 | 対局 | **3人麻雀ルール準拠** | 3人麻雀の基本ルール（萬子の一部除外, チーなし, 抜きドラあり）に沿ってゲームが進行する。 | **高** |
| FR-04 | | **基本操作 (ツモ/打牌)** | ハンドトラッキングで山から牌をツモり、手牌から1枚を捨てる。 | **高** |
| FR-05 | | **鳴き操作 (ポン/カン)** | 他家の捨て牌に対してポン、カンができる。 | **高** |
| FR-06 | | **和了 (アガリ)** | ツモまたはロンによる和了を宣言できる。 | **高** |
| FR-07 | | **翻数計算** | 和了役を自動判定し、翻数を計算・表示する（符計算は行わない）。 | **高** |
| FR-08 | | **点数移動** | 計算された翻数に基づき、プレイヤー間の点数移動を自動で行う。 | **高** |
| FR-09 | MR体験 | **パススルー表示** | 現実の風景を背景としてゲームをプレイできる。 | **高** |
| FR-10 | | **手動での卓配置** | ユーザーが任意で、現実空間の好きな位置に麻雀卓を配置できる。 | **高** |

### 1.3. 非機能要件

| ID | 分類 | 要件 |
| :--- | :--- | :--- |
| NFR-01 | パフォーマンス | **Meta Quest 3**において、常時**72fps以上**を維持する。 |
| NFR-02 | ユーザビリティ | ハンドトラッキングによる操作は直感的で、誤操作が起こりにくい設計とする。 |
| NFR-03 | セキュリティ | 通信の暗号化（TLS）は、本アプリがデプロイされる**パブリッククラウドのインフラ層（ロードバランサー等）で対応**する。 |
| NFR-04 | 稼働環境 | **ターゲットデバイス**: **Meta Quest 3**に限定する。ネットワーク: 常時ブロードバンド接続を前提とする。 |

---

## 第2部 詳細設計書

アーキテクチャを大幅に簡略化し、**データベースを廃止**します。Goサーバーは、ルームID発行用のステートレスなAPIと、対局中の状態をメモリ上でのみ管理するWebSocketサーバーとして機能します。

* **クライアント (Unity)**: 描画、入力処理、MR機能、Photon経由でのモデル同期を担当。
* **Goサーバー**:
    * **REST API**: ルームID発行のみを行う。
    * **WebSocket**: ゲームロジックの権威。対局中の状態をセッション内（メモリ上）でのみ保持する。
* **Photon**: GameObjectのTransform情報（位置・回転）の視覚的な同期のみに利用。



### 2.2. サーバーサイド設計 (Go)

#### 2.2.1. API設計 (REST API)
ルームIDを発行する単一のエンドポイントのみを提供します。

| エンドポイント | メソッド | 説明 | レスポンス (200 OK) |
| :--- | :--- | :--- | :--- |
| `/api/rooms` | `POST` | 新しい対局ルームを作成し、一意のIDを発行する。 | `{"roomId": "A1B2C3"}` |

#### 2.2.2. 通信設計 (WebSocket)
認証フローをなくし、ルームIDをクエリパラメータで渡して接続する方式に変更します。

* **接続URL**: `ws://<server_address>/ws/game?roomId=<ルームID>`
* **メッセージフォーマット**:
    * **クライアント → サーバー (Action)**: `{"action": "action_name", "payload": {...}}`
        * `action_name`: `discard_tile`, `pon`, `kan`, `ron`, `tsumo`
    * **サーバー → クライアント (Event)**: `{"event": "event_name", "payload": {...}}`
        * `event_name`: `game_started`, `player_drew_tile`, `player_discarded`, `next_turn`, `game_result`, `player_joined`

### 2.3. クライアントサイド設計 (Unity)

#### 2.3.1. シーン構成とUIフロー
ログインが不要になったため、アプリ起動後すぐにロビーシーンに遷移します。

1.  **InitializationScene**: アプリの初期化。
2.  **LobbyScene**:
    * UIに「**ルームをつくる**」と「**ルームにはいる**」のボタンを表示。
    * **「ルームをつくる」**: Goサーバーにリクエストを送信し、返ってきたルームID（例: `A1B2C3`）を画面に表示。WebSocket接続を開始し、`GameScene`へ遷移。
    * **「ルームにはいる」**: ルームIDの入力フィールドを表示。ID入力後、そのIDでWebSocket接続を開始し、`GameScene`へ遷移。
3.  **GameScene**: MR空間での麻雀対局シーン。



