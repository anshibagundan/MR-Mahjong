## MR麻雀 (v1.1 MVP) タスク分割計画

バージョン: 1.1 / 変更日: 2025-09-29

対象: `docs/READM.md` で定義されたMVP要件（FR-01〜FR-10, NFR-01〜04）

記法:
- [ ] 未着手 / [~] 進行中 / [x] 完了
- 優先度: 高/中/低、依存: ブロックする上位タスク

---

### マイルストーン0: プロジェクト基盤 (優先度: 高)
- [ ] リポジトリ初期化/整備（`README.md` 整理、`docs` 構成確定）
- [ ] CI最小構成（Lint, ビルド）
- [ ] Go/Unity 共通バージョン固定（Go, Unity, XR SDK, Quest3）
- [ ] 共通環境変数規約（`.env` / ScriptableObject 等）

---

### マイルストーン1: サーバーMVP (Go, ステートレスAPI + WS) [FR-01, FR-02, FR-03, FR-04, FR-05, FR-06, FR-07, FR-08]
依存: マイルストーン0

1) REST: ルームID発行 [FR-01]
- [ ] Goモジュール初期化 (`go mod init`)
- [ ] HTTPサーバー雛形作成（ルーティング/ロギング）
- [ ] `POST /api/rooms` 実装（6桁英数IDの生成、一意性保証）
- [ ] レスポンススキーマ `{"roomId":"A1B2C3"}` 固定
- [ ] ユニットテスト（ID形式/重複なし）

2) WebSocket: ルーム接続/イベント配信 [FR-02, 通信設計]
- [ ] `ws://<host>/ws/game?roomId=<id>` 接続ハンドラ
- [ ] セッション/ルーム管理（メモリ内）
- [ ] 接続/切断イベント、`player_joined` 通知
- [ ] 初回配信: `type: initial_state`（実体は `init` で `tehai/yama/wanpai/oya/scores`）
- [ ] Action 受信: `type: dahai`（`payload.tile`）
- [ ] Event 送信: `type: event`（`payload.playerId/tehai/nextTurn/kawa`）
- [ ] 最低限のメッセージバリデーション/エラー応答

2.1) WebSocket: スコア集計 [FR-07, FR-08]
- [ ] `ws://<host>/ws/score?roomId=<id>` 接続ハンドラ（ゲームWSと同時接続）
- [ ] Client入力: `type: score_input`（`payload.playerId/currentScores(hand map)/win{winnerId, handTiles, yaku[], doras}`）
- [ ] 集約: 3人分受領で計算（実装は段階的に1人からの受信でも即返却可）
- [ ] Server返却: `type: score_result`（`payload.{deltas, newScores, winnerId, han}`）

3) ゲームロジック（3人麻雀MVP）[FR-03, FR-04, FR-05, FR-06]
- [ ] 山/手牌/捨て牌の管理
- [ ] ターン進行（ツモ→打牌→次家）
- [ ] 鳴き処理（ポン/カン）優先順位/割込み制御の簡易版
- [ ] 和了判定（ツモ/ロン）

4) 役判定と翻数計算（符は計算しない）[FR-07]
- [ ] 代表的役の自動判定（MVP対象を限定）
- [ ] 翻数合算/上限処理、単体テスト

5) 点数移動 [FR-08]
- [ ] 翻数→支払点の計算（MVP簡易ルール）
- [ ] 支払いの適用/スコア更新イベント

6) 運用補助
- [ ] 低依存Dockerfile（ビルド/起動）
- [ ] ローカル起動用Makefile or スクリプト

---

### マイルストーン2: クライアントMVP (Unity, Quest3) [FR-02, FR-04, FR-05, FR-06, FR-09, FR-10]
依存: マイルストーン1（API/WS仕様確定）

1) プロジェクト/デバイス設定
- [ ] Unityプロジェクト作成（Quest3, OpenXR, Hand Tracking 有効化）
- [ ] ビルド設定/テンプレートシーン

2) シーン/フロー [2.3.1]
- [ ] `InitializationScene`：初期化/設定ロード
- [ ] `LobbyScene`：
  - [ ] 「ルームをつくる」ボタン → `POST /api/rooms` → ID表示 → WS接続 → `GameScene`遷移 [FR-01, FR-02]
  - [ ] 「ルームにはいる」ボタン/入力 → WS接続 → `GameScene`遷移 [FR-02]
- [ ] `GameScene`：対局表示/操作

3) MR体験 [FR-09, FR-10]
- [ ] パススルー背景表示（Quest3 Passthrough）
- [ ] 卓の手動配置（アンカー/簡易ギズモ）

4) 基本操作UI/入力 [FR-04, FR-05, FR-06]
- [ ] 手牌モデル/山/捨て牌の可視化
- [ ] ハンドトラッキングでのツモ/打牌操作（掴む/置くの誤操作防止）
- [ ] 鳴き（ポン/カン）トリガーUI/ジェスチャ
- [ ] 和了（ツモ/ロン）トリガーUI
- [ ] ターンインジケータ/直近イベント表示

5) 通信
- [ ] WSクライアント（アクション送信/イベント購読）
- [ ] 例外/切断時のUIハンドリング/リトライ

6) Photon連携（Transform同期のみ）
- [ ] Photon導入/ルーム同期の簡易設定（視覚同期に限定）
- [ ] 牌/卓などのTransform同期（ゲーム権威はGoサーバー）

---

### マイルストーン3: 品質/パフォーマンス [NFR-01, NFR-02]
依存: マイルストーン2

- [ ] 72fps維持のプロファイリング（レンダリング/スクリプト/GC）
- [ ] 牌表示のドローコール最適化/メッシュ結合
- [ ] 物理/当たり判定の簡素化とスリープ戦略
- [ ] インタラクションの誤操作分析とUI/ジェスチャ調整

---

### マイルストーン4: セキュリティ/稼働環境/デプロイ [NFR-03, NFR-04]
依存: マイルストーン1（サーバー）

- [ ] インフラ選定（LBでTLS終端可能なPaaS/IaaS）
- [ ] TLS終端/証明書設定（LB側で対応）
- [ ] 環境変数/エンドポイント設定（本番/ステージング）
- [ ] デプロイ自動化（CI/CD 簡易）
- [ ] 運用ログ/最低限のメトリクス

---

### マイルストーン5: QA/受け入れ/リリース
依存: 1〜4の統合

- [ ] 受け入れ観点作成（FR-01〜FR-10, NFR-01〜04 トレーサビリティ）
- [ ] シナリオテスト（3人対局の基本進行/鳴き/和了/点数移動）
- [ ] バイナリ出力（Quest3向け）/配布手順

---

### トレーサビリティ（要件→タスク）
- **FR-01 ルーム作成**: M1-1, M2-2
- **FR-02 ID参加**: M1-2, M2-2
- **FR-03 3人麻雀**: M1-3
- **FR-04 基本操作**: M1-3, M2-4
- **FR-05 鳴き**: M1-3, M2-4
- **FR-06 和了**: M1-3, M2-4
- **FR-07 翻数計算**: M1-4
- **FR-08 点数移動**: M1-5
- **FR-09 パススルー**: M2-3
- **FR-10 卓配置**: M2-3
- **NFR-01 72fps**: M3
- **NFR-02 ユーザビリティ**: M3
- **NFR-03 TLS(インフラ)**: M4
- **NFR-04 稼働環境(Q3/ネット)**: M4

---

### 既知の前提/スコープ
- アカウント/認証は非対応（ルームIDのみ）
- DBは廃止。対局状態はWSセッションメモリ内
- PhotonはTransform同期のみに限定（ゲーム権威はGoサーバー）

---

### 推奨作業順（短サイクル）
1. M0 → M1-1 → M2-2(ロビーUIのみ) → 通し確認
2. M1-2/3（WS/最小ゲーム進行）→ M2-4(打牌) → 通し確認
3. M1-4/5（役/点数）→ M2-4(鳴き/和了) → 通し確認
4. M2-3（MR配置/パススルー）→ M3（最適化）→ M4（デプロイ）


